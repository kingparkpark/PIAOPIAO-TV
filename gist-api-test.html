<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub Gist API 测试工具</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .controls {
            margin-bottom: 20px;
            text-align: center;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .results {
            margin-top: 20px;
        }
        .api-item {
            border: 1px solid #ddd;
            margin: 10px 0;
            padding: 15px;
            border-radius: 5px;
            background: #f9f9f9;
        }
        .api-item.success {
            border-color: #28a745;
            background: #d4edda;
        }
        .api-item.error {
            border-color: #dc3545;
            background: #f8d7da;
        }
        .api-item.testing {
            border-color: #ffc107;
            background: #fff3cd;
        }
        .api-name {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 5px;
        }
        .api-url {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
            word-break: break-all;
        }
        .api-status {
            font-size: 14px;
        }
        .api-details {
            margin-top: 10px;
            font-size: 12px;
            color: #666;
        }
        .progress {
            margin: 20px 0;
            text-align: center;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>GitHub Gist 片源 API 测试工具</h1>
        
        <div class="controls">
            <button id="testAllBtn" onclick="testAllAPIs()">测试所有 API</button>
            <button id="testNormalBtn" onclick="testNormalAPIs()">仅测试正常影视 API</button>
            <button id="clearBtn" onclick="clearResults()">清空结果</button>
        </div>
        
        <div class="progress" id="progress"></div>
        
        <div class="results" id="results"></div>
    </div>

    <script>
        // 从GitHub Gist获取的API列表
        const gistAPIs = [
            {
                "type": 1,
                "name": "if101[屏蔽国内ip]",
                "api": "http://api.if101.tv/v1/vod",
                "category": "normal"
            },
            {
                "type": 0,
                "name": "if101[屏蔽国内ip]",
                "api": "https://demo.if101.tv/api.php/provide/vod/at/xml",
                "category": "normal"
            },
            {
                "type": 0,
                "name": "唐人街",
                "api": "https://www.tangrenjie.tv/api.php/provide/vod/at/xml",
                "category": "normal"
            },
            {
                "type": 8,
                "name": "独播库",
                "api": "https://raw.githubusercontent.com/trial/dp/master/json2/dbk.json",
                "category": "normal"
            },
            {
                "type": 8,
                "name": "欧乐影院",
                "api": "https://raw.githubusercontent.com/trial/dp/master/json2/olevod.json",
                "category": "normal"
            },
            {
                "type": 8,
                "name": "WWDC2022",
                "api": "https://raw.githubusercontent.com/trial/dp/master/json2/wwdc2022.json",
                "category": "normal"
            },
            {
                "type": 0,
                "name": "天堂资源",
                "api": "http://vipmv.cc/api.php/provide/vod/at/xml",
                "category": "normal"
            },
            // 成人内容API (标记为adult)
            {
                "type": 8,
                "name": "Jable",
                "api": "https://raw.githubusercontent.com/trial/dp/master/json2/jable.json",
                "category": "adult"
            },
            {
                "type": 6,
                "name": "麻豆视频",
                "api": "http://madouse.la/api.php/provide/vod/at/xml",
                "category": "adult"
            },
            {
                "type": 6,
                "name": "辣椒资源",
                "api": "http://apilj.com/api.php/provide/vod/at/xml",
                "category": "adult"
            },
            {
                "type": 6,
                "name": "丝袜资源",
                "api": "https://siwazyw.cc/api.php/provide/vod/at/xml",
                "category": "adult"
            },
            {
                "type": 6,
                "name": "环亚资源",
                "api": "http://wmcj8.com/inc/sapi.php",
                "category": "adult"
            },
            {
                "type": 6,
                "name": "一本道资源",
                "api": "https://www.caiji03.com/home/cjapi/cfg8/mc/vod/xml",
                "category": "adult"
            },
            {
                "type": 6,
                "name": "大屌丝资源",
                "api": "http://www.caiji24.com/home/cjapi/p0d2/mc/vod/xml",
                "category": "adult"
            },
            {
                "type": 6,
                "name": "我要啪啪",
                "api": "http://www.caiji21.com/home/cjapi/klkl/mc/vod/xml",
                "category": "adult"
            }
        ];

        let testResults = [];
        let isTestingInProgress = false;

        function updateProgress(current, total) {
            const progressEl = document.getElementById('progress');
            progressEl.textContent = `测试进度: ${current}/${total}`;
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
            document.getElementById('progress').textContent = '';
            testResults = [];
        }

        function createAPIElement(api, status = 'pending') {
            const div = document.createElement('div');
            div.className = `api-item ${status}`;
            div.id = `api-${api.name.replace(/[^a-zA-Z0-9]/g, '')}`;
            
            let statusText = '';
            let statusClass = '';
            
            switch(status) {
                case 'testing':
                    statusText = '🔄 测试中...';
                    statusClass = 'testing';
                    break;
                case 'success':
                    statusText = '✅ 可用';
                    statusClass = 'success';
                    break;
                case 'error':
                    statusText = '❌ 不可用';
                    statusClass = 'error';
                    break;
                default:
                    statusText = '⏳ 等待测试';
                    statusClass = '';
            }
            
            div.innerHTML = `
                <div class="api-name">${api.name} (类型: ${api.type})</div>
                <div class="api-url">${api.api}</div>
                <div class="api-status">${statusText}</div>
                <div class="api-details" id="details-${api.name.replace(/[^a-zA-Z0-9]/g, '')}"></div>
            `;
            
            return div;
        }

        function updateAPIStatus(api, status, details = '') {
            const element = document.getElementById(`api-${api.name.replace(/[^a-zA-Z0-9]/g, '')}`);
            if (element) {
                element.className = `api-item ${status}`;
                
                let statusText = '';
                switch(status) {
                    case 'testing':
                        statusText = '🔄 测试中...';
                        break;
                    case 'success':
                        statusText = '✅ 可用';
                        break;
                    case 'error':
                        statusText = '❌ 不可用';
                        break;
                }
                
                const statusEl = element.querySelector('.api-status');
                if (statusEl) statusEl.textContent = statusText;
                
                const detailsEl = document.getElementById(`details-${api.name.replace(/[^a-zA-Z0-9]/g, '')}`);
                if (detailsEl && details) {
                    detailsEl.textContent = details;
                }
            }
        }

        async function testAPI(api) {
            updateAPIStatus(api, 'testing');
            
            try {
                let testUrl = '';
                
                // 根据API类型构建测试URL
                if (api.type === 8) {
                    // JSON类型，直接访问
                    testUrl = `/api/proxy?url=${encodeURIComponent(api.api)}`;
                } else if (api.type === 0 || api.type === 6) {
                    // XML类型，通常是provide/vod接口
                    if (api.api.includes('provide/vod')) {
                        testUrl = `/api/proxy?url=${encodeURIComponent(api.api + '?ac=videolist&t=1&pg=1')}`;
                    } else {
                        testUrl = `/api/proxy?url=${encodeURIComponent(api.api)}`;
                    }
                } else if (api.type === 1) {
                    // 其他类型
                    testUrl = `/api/proxy?url=${encodeURIComponent(api.api)}`;
                }
                
                const response = await fetch(testUrl, {
                    method: 'GET',
                    timeout: 10000
                });
                
                if (response.ok) {
                    const contentType = response.headers.get('content-type');
                    let data;
                    
                    if (contentType && contentType.includes('application/json')) {
                        data = await response.json();
                    } else {
                        data = await response.text();
                    }
                    
                    // 检查响应内容是否有效
                    let isValid = false;
                    let dataCount = 0;
                    
                    if (typeof data === 'object' && data !== null) {
                        // JSON响应
                        if (data.list && Array.isArray(data.list)) {
                            dataCount = data.list.length;
                            isValid = dataCount > 0;
                        } else if (Array.isArray(data)) {
                            dataCount = data.length;
                            isValid = dataCount > 0;
                        } else if (data.code !== undefined || data.msg !== undefined) {
                            isValid = true;
                        }
                    } else if (typeof data === 'string') {
                        // XML或HTML响应
                        if (data.includes('<rss') || data.includes('<list>') || data.includes('<video>')) {
                            isValid = true;
                            // 尝试计算XML中的条目数
                            const matches = data.match(/<video>/g);
                            dataCount = matches ? matches.length : 0;
                        }
                    }
                    
                    if (isValid) {
                        updateAPIStatus(api, 'success', `响应正常，数据条目: ${dataCount}`);
                        testResults.push({...api, status: 'success', dataCount});
                    } else {
                        updateAPIStatus(api, 'error', '响应格式无效或无数据');
                        testResults.push({...api, status: 'error', error: '响应格式无效'});
                    }
                } else {
                    updateAPIStatus(api, 'error', `HTTP ${response.status}: ${response.statusText}`);
                    testResults.push({...api, status: 'error', error: `HTTP ${response.status}`});
                }
            } catch (error) {
                updateAPIStatus(api, 'error', `错误: ${error.message}`);
                testResults.push({...api, status: 'error', error: error.message});
            }
        }

        async function testAPIs(apiList) {
            if (isTestingInProgress) return;
            
            isTestingInProgress = true;
            const buttons = document.querySelectorAll('button');
            buttons.forEach(btn => btn.disabled = true);
            
            clearResults();
            const resultsEl = document.getElementById('results');
            
            // 创建所有API元素
            apiList.forEach(api => {
                resultsEl.appendChild(createAPIElement(api));
            });
            
            // 逐个测试API
            for (let i = 0; i < apiList.length; i++) {
                updateProgress(i + 1, apiList.length);
                await testAPI(apiList[i]);
                
                // 添加延迟避免请求过于频繁
                if (i < apiList.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
            }
            
            // 显示测试总结
            const successCount = testResults.filter(r => r.status === 'success').length;
            const errorCount = testResults.filter(r => r.status === 'error').length;
            
            updateProgress(`完成`, `成功: ${successCount}, 失败: ${errorCount}`);
            
            // 输出可用的API到控制台
            const workingAPIs = testResults.filter(r => r.status === 'success');
            console.log('可用的API列表:', workingAPIs);
            
            isTestingInProgress = false;
            buttons.forEach(btn => btn.disabled = false);
        }

        function testAllAPIs() {
            testAPIs(gistAPIs);
        }

        function testNormalAPIs() {
            const normalAPIs = gistAPIs.filter(api => api.category === 'normal');
            testAPIs(normalAPIs);
        }
    </script>
</body>
</html>